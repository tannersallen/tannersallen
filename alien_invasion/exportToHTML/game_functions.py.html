<html>
<head>
<title>game_functions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #8c8c8c; font-style: italic;}
.s3 { color: #067d17;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
game_functions.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">json</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">from </span><span class="s1">time </span><span class="s0">import </span><span class="s1">sleep</span>
<span class="s0">import </span><span class="s1">pygame</span>
<span class="s0">from </span><span class="s1">bullet </span><span class="s0">import </span><span class="s1">Bullet</span>
<span class="s0">from </span><span class="s1">alien </span><span class="s0">import </span><span class="s1">Alien</span>

<span class="s0">def </span><span class="s1">check_keydown_events(event, ai_settings, screen, ship, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Respond to key presses. &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">event.key == pygame.K_RIGHT:</span>
        <span class="s2"># Move the ship to the right.</span>
        <span class="s1">ship.moving_right = </span><span class="s0">True</span>
    <span class="s0">elif </span><span class="s1">event.key == pygame.K_LEFT:</span>
        <span class="s2"># Move the ship to the left.</span>
        <span class="s1">ship.moving_left = </span><span class="s0">True</span>
    <span class="s0">elif </span><span class="s1">event.key == pygame.K_SPACE:</span>
        <span class="s2"># Create a new bullet and add it to the bullets group.</span>
        <span class="s1">fire_bullet(ai_settings, screen, ship, bullets)</span>
    <span class="s0">elif </span><span class="s1">event.key == pygame.K_q:</span>
        <span class="s1">sys.exit()</span>

<span class="s0">def </span><span class="s1">save_high_score(stats):</span>
    <span class="s2">&quot;&quot;&quot; Save the high score to a file. &quot;&quot;&quot;</span>
    <span class="s1">filename = </span><span class="s3">'high_score.json'</span>
    <span class="s0">with </span><span class="s1">open(filename, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">json.dump(stats.high_score, f)</span>

<span class="s0">def </span><span class="s1">fire_bullet(ai_settings, screen, ship, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Fire a bullet if limit not reached yet. &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">len(bullets) &lt; ai_settings.bullets_allowed:</span>
        <span class="s1">new_bullet = Bullet(ai_settings, screen, ship)</span>
        <span class="s1">bullets.add(new_bullet)</span>

<span class="s0">def </span><span class="s1">check_keyup_events(event, ship):</span>
    <span class="s2">&quot;&quot;&quot; Respond to key releases. &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">event.key == pygame.K_RIGHT:</span>
        <span class="s1">ship.moving_right = </span><span class="s0">False</span>
    <span class="s0">elif </span><span class="s1">event.key == pygame.K_LEFT:</span>
        <span class="s1">ship.moving_left = </span><span class="s0">False</span>


<span class="s0">def </span><span class="s1">check_events(ai_settings, screen, stats, sb, play_button, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Respond to key presses and mouse events. &quot;&quot;&quot;</span>
    <span class="s0">for </span><span class="s1">event </span><span class="s0">in </span><span class="s1">pygame.event.get():</span>
        <span class="s0">if </span><span class="s1">event.type == pygame.QUIT:</span>
            <span class="s1">save_high_score(stats)</span>
            <span class="s1">sys.exit()</span>
        <span class="s0">elif </span><span class="s1">event.type == pygame.KEYDOWN:</span>
            <span class="s1">check_keydown_events(event, ai_settings, screen, ship, bullets)</span>
        <span class="s0">elif </span><span class="s1">event.type == pygame.KEYUP:</span>
            <span class="s1">check_keyup_events(event,ship)</span>
        <span class="s0">elif </span><span class="s1">event.type == pygame.MOUSEBUTTONDOWN:</span>
            <span class="s1">mouse_x, mouse_y = pygame.mouse.get_pos()</span>
            <span class="s1">check_play_button(ai_settings, screen, stats, sb, play_button, ship, aliens, bullets, mouse_x, mouse_y)</span>


<span class="s0">def </span><span class="s1">check_play_button(ai_settings, screen, stats, sb, play_button, ship, aliens, bullets, mouse_x, mouse_y):</span>
    <span class="s2">&quot;&quot;&quot; Start a new game when the player clicks Play. &quot;&quot;&quot;</span>
    <span class="s1">button_clicked =  play_button.rect.collidepoint(mouse_x, mouse_y)</span>
    <span class="s0">if </span><span class="s1">button_clicked </span><span class="s0">and not </span><span class="s1">stats.game_active:</span>
        <span class="s2"># Reset the game settings.</span>
        <span class="s1">ai_settings.initialize_dynamic_settings()</span>
        <span class="s2"># Hide the mouse cursor.</span>
        <span class="s1">pygame.mouse.set_visible(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s2"># Reset the game statistics.</span>
        <span class="s1">stats.reset_stats()</span>
        <span class="s1">stats.game_active = </span><span class="s0">True</span>

        <span class="s2"># Reset the scoreboard images.</span>
        <span class="s1">sb.prep_score()</span>
        <span class="s1">sb.prep_high_score()</span>
        <span class="s1">sb.prep_level()</span>
        <span class="s1">sb.prep_ships()</span>

        <span class="s2"># Empty the list of aliens and bullets.</span>
        <span class="s1">aliens.empty()</span>
        <span class="s1">bullets.empty()</span>

        <span class="s2"># Create a new fleet and center the ship.</span>
        <span class="s1">create_fleet(ai_settings, screen, ship, aliens)</span>
        <span class="s1">ship.center_ship()</span>


<span class="s0">def </span><span class="s1">update_screen(ai_settings, screen, stats, sb, ship, aliens, bullets, play_button):</span>
    <span class="s2">&quot;&quot;&quot; Update images on the screen and flip to the new screen. &quot;&quot;&quot;</span>
    <span class="s2"># Redraw the screen during each pass through the loop.</span>
    <span class="s1">screen.fill(ai_settings.bg_color)</span>
    <span class="s2"># Redraw all bullets behind ship and aliens.</span>
    <span class="s0">for </span><span class="s1">bullet </span><span class="s0">in </span><span class="s1">bullets.sprites():</span>
        <span class="s1">bullet.draw_bullet()</span>
    <span class="s1">ship.blitme()</span>
    <span class="s1">aliens.draw(screen)</span>

    <span class="s2"># Draw the score information.</span>
    <span class="s1">sb.show_score()</span>

    <span class="s2"># Draw the play button if the game is inactive.</span>
    <span class="s0">if not </span><span class="s1">stats.game_active:</span>
        <span class="s1">play_button.draw_button()</span>

    <span class="s2"># Make the most recently drawn screen visible.</span>
    <span class="s1">pygame.display.flip()</span>

<span class="s0">def </span><span class="s1">update_bullets(ai_settings, screen, stats, sb, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Update position of bullets and get rid of old bullets. &quot;&quot;&quot;</span>
    <span class="s2"># Update bullet positions.</span>
    <span class="s1">bullets.update()</span>

    <span class="s2"># Get rid of bullets that have disappeared.</span>
    <span class="s0">for </span><span class="s1">bullet </span><span class="s0">in </span><span class="s1">bullets.copy():</span>
        <span class="s0">if </span><span class="s1">bullet.rect.bottom &lt;= </span><span class="s4">0</span><span class="s1">:</span>
            <span class="s1">bullets.remove(bullet)</span>

    <span class="s1">check_bullet_alien_collisions(ai_settings, screen, stats, sb, ship, aliens, bullets)</span>

<span class="s0">def </span><span class="s1">check_bullet_alien_collisions(ai_settings, screen, stats, sb, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Respond to bullet-alien collisions&quot;&quot;&quot;</span>
    <span class="s2"># Remove any bullets and aliens that have collided.</span>
    <span class="s1">collisions = pygame.sprite.groupcollide(bullets, aliens, </span><span class="s0">True</span><span class="s1">, </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">collisions:</span>
        <span class="s0">for </span><span class="s1">aliens </span><span class="s0">in </span><span class="s1">collisions.values():</span>
            <span class="s1">stats.score += ai_settings.alien_points * len(aliens)</span>
            <span class="s1">sb.prep_score()</span>
        <span class="s1">check_high_score(stats, sb)</span>

    <span class="s0">if </span><span class="s1">len(aliens) == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s2"># If the entire fleet is destroyed, start a new level.</span>
        <span class="s1">bullets.empty()</span>
        <span class="s1">ai_settings.increase_speed()</span>

        <span class="s2"># Increase level.</span>
        <span class="s1">stats.level += </span><span class="s4">1</span>
        <span class="s1">sb.prep_level()</span>

        <span class="s1">create_fleet(ai_settings, screen, ship, aliens)</span>

    <span class="s2"># Make the most recently drawn screen visible.</span>
    <span class="s1">pygame.display.flip()</span>

<span class="s0">def </span><span class="s1">get_number_aliens_x(ai_settings, alien_width):</span>
    <span class="s2">&quot;&quot;&quot; Determine the number of aliens that fit in a row. &quot;&quot;&quot;</span>
    <span class="s1">available_space_x = ai_settings.screen_width - </span><span class="s4">2 </span><span class="s1">* alien_width</span>
    <span class="s1">number_aliens_x = int(available_space_x / (</span><span class="s4">3 </span><span class="s1">* alien_width))</span>
    <span class="s0">return </span><span class="s1">number_aliens_x</span>

<span class="s0">def </span><span class="s1">get_number_rows(ai_settings, ship_height, alien_height):</span>
    <span class="s2">&quot;&quot;&quot; Determine the number of rows of aliens that fit on the screen. &quot;&quot;&quot;</span>
    <span class="s1">available_space_y = (ai_settings.screen_height - (</span><span class="s4">3 </span><span class="s1">* alien_height) - ship_height)</span>
    <span class="s1">number_rows = int(available_space_y / (</span><span class="s4">4 </span><span class="s1">* alien_height))</span>
    <span class="s0">return </span><span class="s1">number_rows</span>

<span class="s0">def </span><span class="s1">create_alien(ai_settings, screen, aliens, alien_number, row_number):</span>
    <span class="s2">&quot;&quot;&quot; Create an alien and place it in a row. &quot;&quot;&quot;</span>
    <span class="s1">alien = Alien(ai_settings, screen)</span>
    <span class="s1">alien_width = alien.rect.width</span>
    <span class="s1">alien.x = alien_width + </span><span class="s4">3 </span><span class="s1">* alien_width * alien_number</span>
    <span class="s1">alien.rect.x = alien.x</span>
    <span class="s1">alien.rect.y = alien.rect.height + </span><span class="s4">2 </span><span class="s1">* alien.rect.height * row_number</span>
    <span class="s1">aliens.add(alien)</span>

<span class="s0">def </span><span class="s1">create_fleet(ai_settings, screen, ship, aliens):</span>
    <span class="s2">&quot;&quot;&quot; Create a full fleet of aliens. &quot;&quot;&quot;</span>
    <span class="s2"># Create an alien and find the number of aliens in a row.</span>
    <span class="s1">alien = Alien(ai_settings, screen)</span>
    <span class="s1">number_aliens_x = get_number_aliens_x(ai_settings, alien.rect.width)</span>
    <span class="s1">number_rows = get_number_rows(ai_settings, ship.rect.height, alien.rect.height)</span>


    <span class="s2"># Create the fleet of aliens.</span>
    <span class="s0">for </span><span class="s1">row_number </span><span class="s0">in </span><span class="s1">range(number_rows):</span>
        <span class="s0">for </span><span class="s1">alien_number </span><span class="s0">in </span><span class="s1">range(number_aliens_x):</span>
            <span class="s1">create_alien(ai_settings, screen, aliens, alien_number, row_number)</span>

<span class="s0">def </span><span class="s1">check_fleet_edges(ai_settings, aliens):</span>
    <span class="s2">&quot;&quot;&quot; Respond appropriately if any aliens have reached an edge. &quot;&quot;&quot;</span>
    <span class="s0">for </span><span class="s1">alien </span><span class="s0">in </span><span class="s1">aliens.sprites():</span>
        <span class="s0">if </span><span class="s1">alien.check_edges():</span>
            <span class="s1">change_fleet_direction(ai_settings, aliens)</span>
            <span class="s0">break</span>

<span class="s0">def </span><span class="s1">change_fleet_direction(ai_settings, aliens):</span>
    <span class="s2">&quot;&quot;&quot; Drop the entire fleet and change the fleet's direction. &quot;&quot;&quot;</span>
    <span class="s0">for </span><span class="s1">alien </span><span class="s0">in </span><span class="s1">aliens.sprites():</span>
        <span class="s1">alien.rect.y += ai_settings.fleet_drop_speed</span>
    <span class="s1">ai_settings.fleet_direction *= -</span><span class="s4">1</span>


<span class="s0">def </span><span class="s1">ship_hit(ai_settings, stats, screen, sb, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Respond to ship being hit by alien. &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">stats.ships_left &gt; </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s2"># Decrement ships_left.</span>
        <span class="s1">stats.ships_left -= </span><span class="s4">1</span>

        <span class="s2"># Update scoreboard.</span>
        <span class="s1">sb.prep_ships()</span>

        <span class="s2"># Empty the list of aliens and bullets.</span>
        <span class="s1">aliens.empty()</span>
        <span class="s1">bullets.empty()</span>

        <span class="s2"># Create a new fleet and center the ship.</span>
        <span class="s1">create_fleet(ai_settings,screen, ship, aliens)</span>
        <span class="s1">ship.center_ship()</span>

        <span class="s2"># Pause</span>
        <span class="s1">sleep(</span><span class="s4">0.5</span><span class="s1">)</span>

    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">stats.game_active = </span><span class="s0">False</span>
        <span class="s1">save_high_score(stats)</span>
        <span class="s1">pygame.mouse.set_visible(</span><span class="s0">True</span><span class="s1">)</span>

<span class="s0">def </span><span class="s1">check_aliens_bottom(ai_settings, stats, screen, sb, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; Check if any aliens have reached the bottom of the screen. &quot;&quot;&quot;</span>
    <span class="s1">screen_rect = screen.get_rect()</span>
    <span class="s0">for </span><span class="s1">alien </span><span class="s0">in </span><span class="s1">aliens.sprites():</span>
        <span class="s0">if </span><span class="s1">alien.rect.bottom &gt;= screen_rect.bottom:</span>
            <span class="s2"># Treat this the same as if the ship got hit.</span>
            <span class="s1">ship_hit(ai_settings, stats, screen, sb, ship, aliens, bullets)</span>
            <span class="s0">break</span>

<span class="s0">def </span><span class="s1">update_aliens(ai_settings, stats, screen, sb, ship, aliens, bullets):</span>
    <span class="s2">&quot;&quot;&quot; 
    Check if the fleet is at an edge, and then 
    update the positions of all aliens in the fleet. 
    &quot;&quot;&quot;</span>
    <span class="s1">check_fleet_edges(ai_settings, aliens)</span>
    <span class="s1">aliens.update()</span>

    <span class="s2"># Look for alien-ship collisions.</span>
    <span class="s0">if </span><span class="s1">pygame.sprite.spritecollideany(ship, aliens):</span>
        <span class="s1">ship_hit(ai_settings, stats, screen, sb, ship, aliens, bullets)</span>

    <span class="s2"># Look for aliens hitting the bottom of the screen.</span>
    <span class="s1">check_aliens_bottom(ai_settings, stats, screen, sb, ship, aliens, bullets)</span>

<span class="s0">def </span><span class="s1">check_high_score(stats,sb):</span>
    <span class="s2">&quot;&quot;&quot; Check to see if there's a new high score. &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">stats.score &gt; stats.high_score:</span>
        <span class="s1">stats.high_score = stats.score</span>
        <span class="s1">sb.prep_high_score()</span></pre>
</body>
</html>